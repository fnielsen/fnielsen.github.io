<!DOCTYPE html>
<html>
    <head>
	<meta charset="UTF-8"></meta>
	<script src="jquery.min.js" type="text/javascript"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    </head>
    
    <body class="container-fluid bg-dark text-white">
	<div>
	    <div class="row">
		<div class="col-sm text-center">
		    <button id="previous" type="button"
			    class="btn btn-lg bg-dark text-white"
			    onclick="previousImage();">◀</button>
		</div>
		<div class="col-sm text-center">
		    <button id="next" type="button"
			    class="btn btn-lg bg-dark text-white"
			    onclick="nextImage();">▶</button>
		</div>
	    </div>

	    <div class="row">
		<div class="col-sm text-center">
		    <img id="image" style="object-fit: contain;" src=""/>
		</div>
	    </div>

	    <div class="row">
		<div class="col-sm text-center">
		    <div id="title"></div>
		</div>
	    </div>

	    <div class="row">
		<div class="col-sm text-center">
		    <div id="collection"></div>
		</div>
	    </div>

	</div>
    </body>

    <script>
     let image = document.getElementById("image");
     let imageWidth;
     let imageHeight;
     
     let data = {};
     let dataKeys = [];
     let audios = [];
     let positionToAudio = {};
     
     let imageIndex = 0;
     updateImage = function(n) {
	 if (n < 0) { n = 0; }
	 if (n > dataKeys.length - 1) { n = dataKeys.length - 1; }
	 let key = dataKeys[n];

	 let imageWidth = Math.round(window.innerWidth * 0.80);
	 let imageUrl = data[key][0].image + "?width=" + imageWidth;
	 $("#image").attr("src", imageUrl);

	 // $("#title").text(data[key][0].title);
	 // $("#collection").text(data[key][0].collection);
	 
	 positionToAudio = [];
	 for (let i = 0; i < data[key].length & i < 5 ; i++) {
	     positionToAudio[data[key][i].position] = new Audio(data[key][i].sound);
	 }

	 if (imageIndex === dataKeys.length - 1) {
	     document.getElementById('next').style.visibility = 'hidden';
	 }
	 else {
	     document.getElementById('next').style.visibility = 'visible';
	 }	     
	 if (imageIndex === 0) {
	     document.getElementById('previous').style.visibility = 'hidden';
	 }
	 else {
	     document.getElementById('previous').style.visibility = 'visible';
	 }

	 nextImage = function() {
	     imageIndex = imageIndex + 1;
	     if (imageIndex > dataKeys.length - 1) { imageIndex = dataKeys.length - 1; }
	     updateImage(imageIndex);
	 }
	 previousImage = function() {
	     imageIndex = imageIndex - 1;
	     if (imageIndex < 0) { imageIndex = 0; }
	     updateImage(imageIndex);
	 }
     }

     $(document).ready(function() {
	 let sparql = `
           SELECT
             ?art ?position
             (SAMPLE(?sound_) AS ?sound)
             (SAMPLE(?image_) AS ?image)
             (SAMPLE(?artLabel_) AS ?artLabel)
             (SAMPLE(?collection_) AS ?collection)
             (SAMPLE(?collectionLabel_) AS ?collectionLabel)
           WHERE {
             ?art wdt:P195 ?collection_ ;
	          wdt:P18 ?image_ ;
	          p:P180 ?depict_statement .
             ?depict_statement ps:P180 / wdt:P51 ?sound_ ;
                               pq:P2677 ?position .
             ?collection_ wdt:P17 wd:Q35 .
             OPTIONAL {
               ?art wd:P1476 ?artLabel_ .
               FILTER (LANG(?artLabel_) = 'da')
             } 
             OPTIONAL {
               ?collection_ rdfs:label ?collectionLabel_ .
               FILTER (LANG(?collectionLabel_) = 'da')
             }
	   }
           GROUP BY ?art ?position
	 `;

	 let url = "https://query.wikidata.org/sparql?query=" + 
		   encodeURIComponent(sparql) + '&format=json';

	 $.getJSON(url, function(response) {
	     let responseData = response.results.bindings;
	     for (let i = 0; i < responseData.length; i++) {
		 if (data[responseData[i].art.value] === undefined) {
		     data[responseData[i].art.value] = [];
		 }

		 let title = "";
		 if (responseData[i].artLabel) {
		     title = responseData[i].artLabel.value;
		 }
		 let collection = "";
		 if (responseData[i].collectionLabel) {
		     collection = responseData[i].collectionLabel.value;
		 }
		 
		 data[responseData[i].art.value].push({
		     position: responseData[i].position.value,
		     sound: responseData[i].sound.value,
		     image: responseData[i].image.value,
		     title: title,
		     collection: collection,
		 });
	     } 
	     dataKeys = Object.keys(data);
	     
	     updateImage(0);
	 });
	 
	 $("#image").on("click", function(event) {
	     let xPixel = event.pageX - this.offsetLeft;
	     let yPixel = event.pageY - this.offsetTop;
	     let xPercentage = xPixel / document.getElementById("image").width * 100;

	     // Hack
	     let yPercentage = yPixel / document.getElementById("image").height * 90;

	     positionKeys = Object.keys(positionToAudio)
	     for (let j = 0 ; j < positionKeys.length ; j++) {
		 percentages = positionKeys[j].substring(4).split(',').map(Number);
		 if (xPercentage >= percentages[0] &
		     xPercentage <= percentages[0] + percentages[2] &
		     yPercentage >= percentages[1] &
		     yPercentage <= percentages[1] + percentages[3]) {
		     positionToAudio[positionKeys[j]].play();
		 }
	     }
	 });
     });
     
     
    </script>
    
</html>
